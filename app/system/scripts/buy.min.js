(function(a){a.fn.FFI_BE_Buy=function(b){a.extend(a.fn.FFI_BE_Buy.defaults,b);return this.on("click",a.fn.FFI_BE_Buy.defaults.targetObject,function(){if(!a(this).hasClass("disabled")){a.fn.FFI_BE_Buy.button=a(this);a.fn.FFI_BE_Buy.ID=a.fn.FFI_BE_Buy.button.attr("data-id");a.fn.FFI_BE_Buy.title=a.fn.FFI_BE_Buy.htmlEntitiesDecode(a.fn.FFI_BE_Buy.button.attr("data-title"));a.fn.FFI_BE_Buy.author=a.fn.FFI_BE_Buy.htmlEntitiesDecode(a.fn.FFI_BE_Buy.button.attr("data-author"));a.fn.FFI_BE_Buy.image=a.fn.FFI_BE_Buy.htmlEntitiesDecode(a.fn.FFI_BE_Buy.button.attr("data-image"));a.fn.FFI_BE_Buy.price=a.fn.FFI_BE_Buy.button.attr("data-price");a.fn.FFI_BE_Buy.comments=null;a.fn.FFI_BE_Buy.modal=null;a.fn.FFI_BE_Buy.password=null;a.fn.FFI_BE_Buy.submit=null;a.fn.FFI_BE_Buy.username=null;a.fn.FFI_BE_Buy.validationPrompt=null;a.fn.FFI_BE_Buy.buildDialog();a.fn.FFI_BE_Buy.submitHandler()}})};a.fn.FFI_BE_Buy.buildDialog=function(){var b='<div class="modal hide fade purchase-dialog" role="dialog">';b+='<div class="modal-header">';b+='<button type="button" class="close" data-dismiss="modal">×</button>';b+="<h3>Purchase Request</h3>";b+="</div>";b+='<div class="modal-body book-purchase-details">';b+='<img src="'+a.fn.FFI_BE_Buy.image+'">';b+="<h4>"+a.fn.FFI_BE_Buy.title+"</h4>";b+="<h5>by "+a.fn.FFI_BE_Buy.author+"</h5>";b+='<p class="price">$'+a.fn.FFI_BE_Buy.price+".00</p>";b+="</div>";if(a.fn.FFI_BE_Buy.defaults.showComments){b+='<div class="modal-body comments">';b+="<h4>Share comments with the merchant (optional):</h4>";b+='<textarea name="content" />';b+="</div>"}if(a.fn.FFI_BE_Buy.defaults.showLogin){if(a.fn.FFI_BE_Buy.placeholderSupported()){b+='<div class="modal-footer login">'}else{b+='<div class="modal-footer login fallback">';b+='<h4 class="placeholder">Username &amp; password:</h4>'}b+='<input class="username" placeholder="Username" type="text">';b+='<input class="password" placeholder="Password" type="password">';b+="</div>"}b+='<div class="modal-footer">';b+='<span class="validate"></span>';b+='<button class="btn btn-primary confirm">'+(a.fn.FFI_BE_Buy.defaults.showLogin?"Login &amp;":"Confirm")+" Purchase</button>";b+='<button class="btn close-dialog" data-dismiss="modal">Close</button>';b+="</div>";b+="</div>";a.fn.FFI_BE_Buy.modal=a(b);a.fn.FFI_BE_Buy.modal.on("shown",function(){if(a.fn.FFI_BE_Buy.defaults.showComments){a.fn.FFI_BE_Buy.comments=a.fn.FFI_BE_Buy.modal.find("textarea");if(a.fn.FFI_BE_Buy.comments.parent().is(":visible")){tinymce.init({selector:"textarea",plugins:["autolink contextmenu image link table"],menubar:false,statusbar:false,toolbar:false});tinymce.activeEditor.focus()}}}).modal();if(a.fn.FFI_BE_Buy.defaults.showLogin){a.fn.FFI_BE_Buy.password=a.fn.FFI_BE_Buy.modal.find("input.password");a.fn.FFI_BE_Buy.username=a.fn.FFI_BE_Buy.modal.find("input.username")}a.fn.FFI_BE_Buy.submit=a.fn.FFI_BE_Buy.modal.find("button.confirm");a.fn.FFI_BE_Buy.validationPrompt=a.fn.FFI_BE_Buy.modal.find("span.validate")};a.fn.FFI_BE_Buy.placeholderSupported=function(){var b=document.createElement("input");return("placeholder" in b)};a.fn.FFI_BE_Buy.submitHandler=function(){a.fn.FFI_BE_Buy.submit.click(function(){if(a.fn.FFI_BE_Buy.defaults.showLogin&&!a.fn.FFI_BE_Buy.validate()){a.fn.FFI_BE_Buy.msg("Please enter your login credentials");return}a.fn.FFI_BE_Buy.clearMsg();a.fn.FFI_BE_Buy.submit.attr("disabled","disabled").addClass("disabled").html("Please wait...");if(tinymce.activeEditor!=null){tinymce.activeEditor.save()}var b={id:a.fn.FFI_BE_Buy.ID};if(a.fn.FFI_BE_Buy.defaults.showComments){b.comments=a.fn.FFI_BE_Buy.comments.val()}if(a.fn.FFI_BE_Buy.defaults.showLogin){b.username=a.fn.FFI_BE_Buy.username.val();b.password=a.fn.FFI_BE_Buy.password.val()}a.ajax({data:b,type:"POST",url:a.fn.FFI_BE_Buy.defaults.processURL,success:function(d){if(d=="success"){a.fn.FFI_BE_Buy.modal.modal("hide");a.fn.FFI_BE_Buy.button.attr("disabled","disabled").addClass("disabled").html("Purchased");a.fn.FFI_BE_Buy.button.parent().parent().addClass("purchased");a.fn.FFI_BE_Buy.button.siblings("p.price").html("<em>Purchased</em>");a("span.purchase").attr("disabled","disabled").addClass("disabled").html("Purchased");if(a.fn.FFI_BE_Buy.defaults.showLogin){a.fn.FFI_BE_Buy.defaults.showLogin=false}var c=a('<span class="success"/>');c.appendTo("body").text("Your purchase request is on its way! Keep an eye on your inbox. ;-)");setTimeout(function(){c.fadeOut(500,function(){c.remove()})},5000)}else{a.fn.FFI_BE_Buy.msg(d);a.fn.FFI_BE_Buy.submit.removeAttr("disabled").removeClass("disabled").html((a.fn.FFI_BE_Buy.defaults.showLogin?"Login &amp;":"Confirm")+" Purchase")}}})})};a.fn.FFI_BE_Buy.validate=function(){return a.fn.FFI_BE_Buy.username.val()!=""&&a.fn.FFI_BE_Buy.password.val()!=""};a.fn.FFI_BE_Buy.msg=function(b){a.fn.FFI_BE_Buy.validationPrompt.text(b);if(a.fn.FFI_BE_Buy.validationPrompt.is(":hidden")){alert(b)}};a.fn.FFI_BE_Buy.clearMsg=function(){a.fn.FFI_BE_Buy.validationPrompt.text("")};a.fn.FFI_BE_Buy.htmlEntitiesDecode=function(b){return a("<div/>").html(b).text()};a.fn.FFI_BE_Buy.defaults={processURL:document.location.href.substring(0,document.location.href.indexOf("book-exchange"))+"wp-content/plugins/book-exchange/app/system/ajax/purchase.php",showComments:true,showLogin:true,targetObject:"button.purchase, span.purchase"}})(jQuery);